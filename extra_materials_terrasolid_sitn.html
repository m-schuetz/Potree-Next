<html>
<head>
<link rel="stylesheet" href="resources/potree.css">
</head>
<body style="padding: 0; margin: 0">

<div id="potree" style="width: 100%; height: 100%; position: fixed;">
	<span style="position: relative; width: 100%; height: 100%; display: flex">
		<canvas id="canvas" width="800" height="600" style="width: 100%; height: 100%;"></canvas>
		<pre id="msg_resources"></pre>
		<pre id="msg_dbg"></pre>
	</span>
</div>

<span id="big_message"></span>

<script type="importmap">
{
	"imports": {
		"potree":        "./src/Potree.js",
		"lazperf":       "./libs/laz-perf/laz-perf.js",
		"toolbar":       "./src/modules/toolbar/toolbar.js",
		"sidebar":       "./src/modules/sidebar/sidebar.js",
		"dat.gui":       "./libs/dat.gui/dat.gui.module.js",
		"BinaryHeap":    "./libs/BinaryHeap/BinaryHeap.js",
		"tween":         "./libs/tween/tween.esm.js",
		"range-select":  "./libs/range-select/RangeSelect.js",
		"json5":         "./libs/json5/json5.js",
		"proj4":         "./libs/proj4js/proj4-src.js",
		"radix-sort-esm":   "./libs/webgpu-radix-sort/dist/esm/radix-sort-esm.js"
	}
}
</script>

<script type="module">

	import {Potree} from "potree";
	import {Vector3, Matrix4, Box3, Mesh, Geometry, geometries, Points, PointLight} from "potree";
	import {WireframeMaterial, TriangleColorMaterial} from "potree";
	import {CopcLoader, Image360, Images360, Images360Loader, SplatType} from "potree";
	import {PotreeLoader, Potree3Loader, TDTilesLoader} from "potree";
	import "range-select";
	import {proj4} from "proj4";
	import * as TWEEN from "tween";
	import {load as loadGLB} from "./src/misc/GLBLoader.js";
	import {MAPPINGS} from "./src/modules/attributes/mappings.js";

	console.log(proj4.version);

	// import {installToolbar} from "toolbar";
	import {installSidebar} from "sidebar";

	let canvas = document.getElementById("canvas");
	let elPotree = document.getElementById("potree");
	let potree = await Potree.init(canvas);
	let {scene, controls} = potree;

	window.sidebar = installSidebar(elPotree, potree);

	window.Potree = Potree;
	window.potree = potree;
	window.Vector3 = Vector3;

	Potree.settings.edlEnabled = true;
	Potree.settings.dilateEnabled = false;
	Potree.settings.hqsEnabled = true;

	// default, if not overriden later on
	controls.set({
		position: [-19.0, 13.6, 12.2],
		pivot: [-0.0, 2.2, 3.9],
	});

	Potree.settings.pointBudget = 4_000_000;
	Potree.settings.attribute = "rgba";
	Potree.settings.pointSize = 3;
	Potree.settings.splatType = SplatType.POINTS;

	// Potree.load("./resources/pointclouds/lidar2022_las14_extra_attributes/metadata.json").then(pointcloud => {
	Potree.load("https://users.cg.tuwien.ac.at/mschuetz/permanent/potree-next/resources/lidar2022_las14_extra_attributes/metadata.json").then(pointcloud => {

		window.pointcloud = pointcloud;
		pointcloud.name = "sitn extra attributes";

		controls.set({
			position: [2562190.1, 1204847.8, 695.2],
			pivot:    [2562251.5, 1205166.7, 444.8]
		});

		let material = pointcloud.material;

		console.log(material.attributes);
		
		material.registerMapping(MAPPINGS.TERRASCAN_NORMAL);
		material.registerMapping(MAPPINGS.TERRASCAN_GROUP);

		scene.root.children.push(pointcloud);
	});

</script>

</body>
</html>